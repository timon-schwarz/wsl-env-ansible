---
# SSH role: import Windows-host keys into the Linux filesystem for the active wsl_profile.
# This role intentionally does NOT manage ~/.ssh/config (dotfiles role owns content).

- name: Ensure ~/.ssh and per-profile key dir exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0700"
  loop:
    - "{{ ansible_user_dir }}/.ssh"
    - "{{ ansible_user_dir }}/.ssh/keys"

- name: Read Windows userprofile (written by windows/bootstrap.ps1)
  ansible.builtin.slurp:
    src: "{{ ssh_windows_userprofile_file }}"
  register: winprof_raw

- name: Compute Windows key source dir for this profile (WSL-mounted)
  ansible.builtin.set_fact:
    ssh_windows_source_profile_dir: >-
      {{ '/mnt/c/' ~
         ((winprof_raw.content | b64decode | trim)
           | regex_replace('^([A-Za-z]):\\\\', '')
           | regex_replace('\\\\', '/'))
         ~ '/' ~ ssh_windows_keys_rel ~ '/' ~ wsl_profile
      }}

- name: Import SSH keys for profile from Windows into Linux
  ansible.builtin.copy:
    src: "{{ ssh_windows_source_profile_dir }}/{{ item.name }}"
    dest: "{{ ssh_linux_keys_dir }}//{{ item.name }}"
    mode: "{{ item.mode }}"
  loop:
    - { name: "id_ed25519", mode: "0600" }
    - { name: "id_ed25519.pub", mode: "0644" }
