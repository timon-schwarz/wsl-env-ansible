- name: Ensure ~/.ssh exists
  ansible.builtin.file:
    path: "{{ ansible_user_dir }}/.ssh"
    state: directory
    mode: "0700"

- name: Read Windows userprofile path (if available)
  ansible.builtin.slurp:
    src: "{{ ssh_windows_userprofile_file }}"
  register: winprof_raw
  ignore_errors: true

- name: Parse Windows userprofile
  ansible.builtin.set_fact:
    win_userprofile: "{{ (winprof_raw.content | b64decode | trim) if (winprof_raw is defined and winprof_raw.content is defined) else '' }}"

- name: Build Windows source base path (WSL-mounted)
  ansible.builtin.set_fact:
    ssh_windows_source_base: >-
      {{ '/mnt/c/' ~ (win_userprofile | regex_replace('^([A-Za-z]):\\\\', '') | regex_replace('\\\\', '/')) ~ '/' ~ ssh_windows_keys_rel }}
  when: win_userprofile | length > 0

- name: Fallback Windows source base path (not recommended; requires manual edit)
  ansible.builtin.set_fact:
    ssh_windows_source_base: "/mnt/c/Users/CHANGE_ME/{{ ssh_windows_keys_rel }}"
  when: win_userprofile | length == 0

- name: Ensure linux key dir for profile exists
  ansible.builtin.file:
    path: "{{ ssh_linux_keys_dir }}/{{ wsl_profile }}"
    state: directory
    mode: "0700"

- name: Stat Windows private key
  ansible.builtin.stat:
    path: "{{ ssh_windows_source_base }}/{{ wsl_profile }}/id_ed25519"
  register: win_priv

- name: Stat Windows public key
  ansible.builtin.stat:
    path: "{{ ssh_windows_source_base }}/{{ wsl_profile }}/id_ed25519.pub"
  register: win_pub

- name: Copy private key from Windows to Linux
  ansible.builtin.copy:
    src: "{{ ssh_windows_source_base }}/{{ wsl_profile }}/id_ed25519"
    dest: "{{ ssh_linux_keys_dir }}/{{ wsl_profile }}/id_ed25519"
    mode: "0600"
  when: win_priv.stat.exists

- name: Copy public key from Windows to Linux
  ansible.builtin.copy:
    src: "{{ ssh_windows_source_base }}/{{ wsl_profile }}/id_ed25519.pub"
    dest: "{{ ssh_linux_keys_dir }}/{{ wsl_profile }}/id_ed25519.pub"
    mode: "0644"
  when: win_pub.stat.exists

- name: Warn if keys are missing (do not fail)
  ansible.builtin.debug:
    msg: "SSH keys not found for profile '{{ wsl_profile }}' under {{ ssh_windows_source_base }}/{{ wsl_profile }}; skipping import."
  when: not (win_priv.stat.exists and win_pub.stat.exists)
