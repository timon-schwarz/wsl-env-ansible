- name: Detect WSL
  ansible.builtin.set_fact:
    is_wsl: "{{ 'microsoft' in (ansible_kernel | lower) or 'wsl' in (ansible_kernel | lower) }}"

- name: Print WSL detection
  ansible.builtin.debug:
    msg: "WSL detected: {{ is_wsl }} (kernel={{ ansible_kernel }})"

- name: Ensure ~/.ssh exists with correct permissions
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.ssh"
    state: directory
    mode: "0700"
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"

- name: Stat SSH config files (if present)
  ansible.builtin.stat:
    path: "{{ item }}"
  loop:
    - "{{ ansible_env.HOME }}/.ssh/config"
    - "{{ ansible_env.HOME }}/.ssh/authorized_keys"
    - "{{ ansible_env.HOME }}/.ssh/known_hosts"
  register: ssh_cfg_stats

- name: Fix permissions for SSH config files if present
  ansible.builtin.file:
    path: "{{ item.stat.path }}"
    state: file
    mode: "{{ (item.stat.path | basename) == 'known_hosts' | ternary('0644', '0600') }}"
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"
  loop: "{{ ssh_cfg_stats.results }}"
  when:
    - item.stat.exists
    - item.stat.isreg

- name: Find candidate private key files under ~/.ssh
  ansible.builtin.find:
    paths: "{{ ansible_env.HOME }}/.ssh"
    file_type: file
    patterns:
      - "id_*"
      - "*.pem"
    use_regex: false
  register: ssh_key_candidates

- name: Restrict permissions on private key candidates
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: file
    mode: "0600"
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"
  loop: "{{ ssh_key_candidates.files }}"
  when:
    - ssh_key_candidates is defined
    - ssh_key_candidates.matched | default(0) | int > 0
    - item.path is not match('.*\\.pub$')
