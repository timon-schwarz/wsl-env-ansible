---
# Deploy all regular files under dotfiles_tree_src into $HOME preserving relative paths.
- name: Check dotfiles source tree exists
  ansible.builtin.stat:
    path: "{{ dotfiles_tree_src }}"
  register: dotfiles_tree_stat

- name: Find files in dotfiles tree
  ansible.builtin.find:
    paths: "{{ dotfiles_tree_src }}"
    file_type: file
    hidden: true
    recurse: true
    excludes:
      - ".gitkeep"
  register: dotfiles_tree_files
  when: dotfiles_tree_stat.stat.exists

- name: Compute backup timestamp
  ansible.builtin.set_fact:
    dotfiles_backup_ts: "{{ lookup('pipe', 'date +%Y%m%d%H%M%S') }}"
  when:
    - dotfiles_tree_stat.stat.exists
    - dotfiles_tree_files.files is defined
    - (dotfiles_tree_files.files | length) > 0

- name: Deploy dotfiles (symlinks)
  ansible.builtin.include_tasks: link_one.yml
  loop: "{{ dotfiles_tree_files.files }}"
  loop_control:
    label: "{{ item.path }}"
  vars:
    dotfile_src: "{{ item.path }}"
    dotfile_rel: "{{ item.path | relpath(dotfiles_tree_src) }}"
    dotfile_dest: "{{ home_dir }}/{{ dotfile_rel }}"
  when:
    - dotfiles_tree_stat.stat.exists
    - dotfiles_tree_files.files is defined
    - (dotfiles_tree_files.files | length) > 0
